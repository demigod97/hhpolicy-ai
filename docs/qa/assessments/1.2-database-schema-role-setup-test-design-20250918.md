# Test Design: Story 1.2 - Initial Database Schema & Role Setup

Date: 2025-09-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 14
- **Unit tests**: 3 (21%)
- **Integration tests**: 7 (50%)
- **E2E tests**: 4 (29%)
- **Priority distribution**: P0: 10, P1: 4, P2: 0

**Risk-Driven Strategy**: This foundational security story requires comprehensive testing across all levels due to critical RLS policy bypass risk (SEC-001) and data migration risks (DATA-001).

## Test Scenarios by Acceptance Criteria

### AC1: Database Migration Script Updates Schema

**Requirement**: Migration script updates schema to include `user_roles` and `policy_documents` tables

#### Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 1.2-UNIT-001 | Unit | P0 | Validate user_roles table schema definition | Pure schema validation logic - fast feedback | TECH-002 |
| 1.2-INT-001 | Integration | P0 | Execute migration script successfully | Database operation requiring real DB | DATA-001 |
| 1.2-INT-002 | Integration | P0 | Verify foreign key relationships post-migration | Multi-table integrity validation | TECH-002, DATA-001 |
| 1.2-INT-006 | Integration | P1 | Verify migration rollback integrity | Recovery procedure validation | TECH-001, DATA-001 |
| 1.2-E2E-004 | E2E | P1 | Complete migration with data verification | Full migration workflow with existing data | DATA-001, TECH-001 |

**Coverage**: Migration execution, schema validation, data integrity, rollback procedures

### AC2: Role Assignment Mechanism

**Requirement**: Mechanism exists to assign new users the 'Administrator' role

#### Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 1.2-UNIT-002 | Unit | P0 | Validate role enum constraints | Business rule validation logic | SEC-002 |
| 1.2-UNIT-003 | Unit | P0 | Test role assignment validation logic | Pure authorization logic | SEC-002 |
| 1.2-INT-005 | Integration | P0 | Test role assignment database operations | Role persistence validation | SEC-002, DATA-002 |
| 1.2-INT-007 | Integration | P1 | Test concurrent role assignments | Multi-user scenario validation | DATA-002 |
| 1.2-E2E-001 | E2E | P0 | Super-admin assigns Administrator role | Critical compliance workflow | SEC-002 |

**Coverage**: Role validation, assignment logic, persistence, concurrency, end-to-end workflow

### AC3: RLS Policy Updates

**Requirement**: RLS policy updated for `policy_documents` - users can only see documents they own

#### Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 1.2-INT-003 | Integration | P0 | Test RLS policy enforcement per role | Critical security boundary testing | **SEC-001** |
| 1.2-INT-004 | Integration | P0 | Verify cross-role data isolation | Security isolation validation | **SEC-001** |
| 1.2-E2E-002 | E2E | P0 | Administrator cannot see Executive documents | Role separation validation | **SEC-001** |
| 1.2-E2E-003 | E2E | P0 | Executive cannot see Administrator documents | Role separation validation | **SEC-001** |

**Coverage**: RLS enforcement, role separation, unauthorized access prevention

## Critical Risk Coverage Analysis

### SEC-001: RLS Policy Bypass (Critical Risk - Score 9)
**Test Coverage**:
- 1.2-INT-003: Direct RLS policy enforcement testing
- 1.2-INT-004: Cross-role data isolation verification
- 1.2-E2E-002: Administrator role boundary testing
- 1.2-E2E-003: Executive role boundary testing

**4 tests dedicated to critical security risk - COMPREHENSIVE COVERAGE**

### DATA-001: Migration Data Loss (High Risk - Score 6)
**Test Coverage**:
- 1.2-INT-001: Migration execution validation
- 1.2-INT-002: Post-migration data integrity
- 1.2-INT-006: Rollback procedure testing
- 1.2-E2E-004: Complete migration workflow

**4 tests for data integrity - ADEQUATE COVERAGE**

### SEC-002: Privilege Escalation (High Risk - Score 6)
**Test Coverage**:
- 1.2-UNIT-002: Role constraint validation
- 1.2-UNIT-003: Assignment logic testing
- 1.2-INT-005: Role persistence validation
- 1.2-E2E-001: End-to-end role assignment

**4 tests for role security - ADEQUATE COVERAGE**

## Detailed Test Specifications

### Priority 0 Tests (MUST EXECUTE)

#### 1.2-UNIT-001: Validate user_roles Table Schema
```sql
-- Test Data
CREATE TABLE test_user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  role TEXT NOT NULL CHECK (role IN ('administrator', 'executive', 'super_admin')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Test Cases
- Verify table creation succeeds
- Validate role enum constraint accepts valid values
- Verify role enum constraint rejects invalid values
- Confirm foreign key reference to auth.users
- Validate default timestamp values
```

#### 1.2-INT-003: Test RLS Policy Enforcement (CRITICAL)
```sql
-- Test Setup
-- Create test users with different roles
-- Create test policy documents owned by each role

-- Test Cases
1. Administrator user queries policy_documents
   - Should only see documents they own
   - Should NOT see Executive-owned documents

2. Executive user queries policy_documents
   - Should only see documents they own
   - Should NOT see Administrator-owned documents

3. Super-admin user queries policy_documents
   - Should see all documents (per requirement)

4. User with no role queries policy_documents
   - Should see no documents or get access denied
```

#### 1.2-E2E-001: Super-admin Assigns Administrator Role
```gherkin
Feature: Role Assignment by Super-Admin

Scenario: Super-admin successfully assigns Administrator role
  Given I am logged in as a super-admin user
  And a new user exists without assigned roles
  When I navigate to user management
  And I select the new user
  And I assign the "Administrator" role
  Then the user should have Administrator role in database
  And the role assignment should be logged in audit trail
  And the user should be able to access Administrator features
```

### Priority 1 Tests (SHOULD EXECUTE)

#### 1.2-INT-006: Verify Migration Rollback Integrity
```sql
-- Test Process
1. Take database snapshot before migration
2. Execute migration (create tables, move data)
3. Verify migration success
4. Execute rollback procedure
5. Verify database matches original snapshot
6. Confirm no data loss occurred
```

#### 1.2-INT-007: Test Concurrent Role Assignments
```javascript
// Test concurrent role assignments
async function testConcurrentRoleAssignments() {
  const user1 = await createTestUser();
  const user2 = await createTestUser();

  // Attempt simultaneous role assignments
  const assignments = await Promise.all([
    assignRole(user1.id, 'administrator'),
    assignRole(user2.id, 'executive'),
    assignRole(user1.id, 'executive') // Should fail - user already has role
  ]);

  // Verify only valid assignments succeeded
  // Verify no race conditions or data corruption
}
```

## Test Environment Requirements

### Unit Tests
- **Framework**: Jest/Vitest with TypeScript
- **Database**: None (mocked dependencies)
- **Duration**: < 100ms per test
- **Dependencies**: Schema validation utilities

### Integration Tests
- **Framework**: Jest with Supabase test client
- **Database**: Supabase test instance with clean state
- **Duration**: < 5 seconds per test
- **Dependencies**: Test database with auth.users table

### E2E Tests
- **Framework**: Playwright with Supabase staging
- **Database**: Staging environment with test data
- **Duration**: < 30 seconds per test
- **Dependencies**: Full staging environment, test user accounts

## Test Data Management

### Test Users Required
```yaml
super_admin_user:
  email: 'super-admin-test@example.com'
  role: 'super_admin'

administrator_test_user:
  email: 'admin-test@example.com'
  role: 'administrator'

executive_test_user:
  email: 'exec-test@example.com'
  role: 'executive'

no_role_user:
  email: 'norole-test@example.com'
  role: null
```

### Test Policy Documents
```yaml
admin_document:
  title: 'HR Policy Document'
  role_assignment: 'administrator'
  owner: administrator_test_user

executive_document:
  title: 'Executive Strategy Document'
  role_assignment: 'executive'
  owner: executive_test_user
```

## Execution Strategy

### Phase 1: Unit Tests (Fast Feedback)
- Execute all P0 unit tests first
- Must pass before proceeding to integration tests
- Estimated time: 5 minutes

### Phase 2: Critical Integration Tests
- Execute P0 integration tests focused on SEC-001 risk
- RLS policy testing is MANDATORY before any deployment
- Estimated time: 15 minutes

### Phase 3: E2E Validation
- Execute P0 E2E tests for role separation validation
- Critical for compliance verification
- Estimated time: 10 minutes

### Phase 4: Rollback and Recovery Tests
- Execute P1 tests for migration rollback procedures
- Required for production deployment confidence
- Estimated time: 20 minutes

## Success Criteria

### Must Pass (P0 Tests)
- ✅ All 10 P0 tests must pass
- ✅ SEC-001 risk mitigated (4 security tests pass)
- ✅ Migration integrity validated (3 tests pass)
- ✅ Role assignment secure (3 tests pass)

### Should Pass (P1 Tests)
- ✅ Migration rollback procedures validated
- ✅ Concurrent operations handle correctly
- ✅ End-to-end migration workflow verified

## Test Maintenance Strategy

### Regression Prevention
- Add these tests to CI/CD pipeline
- Run P0 tests on every commit affecting database schema
- Run full suite before any production deployment

### Test Data Cleanup
- Automated test data cleanup between test runs
- Isolated test environments to prevent cross-contamination
- Backup/restore procedures for integration tests

## Quality Gates Integration

Tests directly support quality gate decisions:
- **SEC-001 Critical Risk**: 4 dedicated test scenarios
- **Gate FAIL → PASS**: All P0 tests must pass
- **Risk Mitigation**: Each high-priority risk has minimum 3 test scenarios

## Coverage Validation

### Acceptance Criteria Coverage
- ✅ AC1: 5 tests (migration, schema, rollback)
- ✅ AC2: 5 tests (role assignment, validation, workflows)
- ✅ AC3: 4 tests (RLS policies, role separation)

### Risk Coverage
- ✅ SEC-001 (Critical): 4 tests
- ✅ DATA-001 (High): 4 tests
- ✅ SEC-002 (High): 4 tests
- ✅ All other risks: Minimum 1 test each

### Test Level Distribution
- Unit: 21% (fast feedback, business logic)
- Integration: 50% (critical for database/security testing)
- E2E: 29% (compliance and user journey validation)

**Test design complete - 14 comprehensive scenarios covering all acceptance criteria and critical security risks.**