# Test Design: Story 2.1 - Administrator Assignment of Executive Policies

Date: 2025-09-19  
Designer: Quinn (Test Architect)  
Story: 2.1.administrator-executive-policy-assignment.md

## Test Strategy Overview

- **Total test scenarios**: 24
- **Unit tests**: 9 (37.5%)
- **Integration tests**: 10 (41.7%)
- **E2E tests**: 5 (20.8%)
- **Priority distribution**: P0: 14, P1: 8, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Document Management UI Role Selection

**Requirement**: The document management UI allows an Administrator to select the 'Executive' role when uploading or editing a policy document

#### Unit Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-UNIT-001 | Unit | P0 | Role selection dropdown renders with correct options | Pure component rendering logic | **UI-001** |
| 2.1-UNIT-002 | Unit | P0 | Form validation requires role selection | Client-side validation logic | **DATA-001** |
| 2.1-UNIT-003 | Unit | P1 | Default role assignment to 'administrator' | Component state management | **UI-001** |

#### Integration Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-INT-001 | Integration | P0 | Upload component integrates role selection with upload hook | Component-hook interaction | **TECH-001** |
| 2.1-INT-002 | Integration | P1 | Role selection persists through upload process | State management across async operations | **DATA-001** |

#### E2E Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-E2E-001 | E2E | P0 | Administrator uploads document with Executive role assignment | Critical user journey | **SEC-001** |

---

### AC2: Database Association with Executive Role

**Requirement**: The document's record in the database is correctly associated with the 'Executive' role in the role_assignment field

#### Unit Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-UNIT-004 | Unit | P0 | Upload payload includes role_assignment field | Data transformation logic | **DATA-001** |
| 2.1-UNIT-005 | Unit | P0 | Validate role_assignment field accepts valid enum values | Input validation logic | **SEC-001** |
| 2.1-UNIT-006 | Unit | P0 | Reject invalid role_assignment values | Security validation logic | **SEC-001** |

#### Integration Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-INT-003 | Integration | P0 | Document creation with role_assignment persists to database | Database operation validation | **DATA-001** |
| 2.1-INT-004 | Integration | P0 | Database constraints enforce role_assignment enum values | Database integrity validation | **SEC-001** |
| 2.1-INT-005 | Integration | P1 | Role assignment update operation works correctly | Database update operation | **DATA-001** |

---

### AC3: Document Segregation and Visibility

**Requirement**: Once assigned to the 'Executive' role, the document is no longer visible in the Administrator's own dashboard or searchable via their chat interface

#### Unit Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-UNIT-007 | Unit | P1 | Document filtering logic excludes Executive documents for Administrator | Pure filtering logic | **SEC-001** |
| 2.1-UNIT-008 | Unit | P1 | Chat interface query builder respects role filtering | Query construction logic | **SEC-001** |
| 2.1-UNIT-009 | Unit | P2 | Search result filtering applies role-based constraints | Search logic validation | **SEC-001** |

#### Integration Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-INT-006 | Integration | P0 | RLS policies prevent Administrator access to Executive documents | Critical security boundary | **SEC-001** |
| 2.1-INT-007 | Integration | P0 | Dashboard queries filter documents by role assignment | UI-database interaction | **SEC-001** |
| 2.1-INT-008 | Integration | P0 | Chat interface respects role-based document access | Cross-component integration | **SEC-001** |
| 2.1-INT-009 | Integration | P1 | Document visibility changes immediately after role assignment | Real-time data consistency | **DATA-001** |
| 2.1-INT-010 | Integration | P1 | Bulk role assignment operations maintain consistency | Batch operation integrity | **DATA-001** |

#### E2E Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-E2E-002 | E2E | P0 | Administrator cannot see Executive documents in dashboard | Critical security validation | **SEC-001** |
| 2.1-E2E-003 | E2E | P0 | Administrator chat interface excludes Executive documents | End-to-end security check | **SEC-001** |
| 2.1-E2E-004 | E2E | P1 | Role assignment change updates document visibility | Complete workflow validation | **DATA-001** |

---

### AC4-6: Integration Requirements

**Requirements**: AC4-6 cover existing functionality, integration patterns, and quality requirements

#### Integration Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-INT-011 | Integration | P1 | Existing upload functionality continues to work | Regression prevention | **TECH-001** |

#### E2E Test Scenarios

| ID | Level | Priority | Test Scenario | Justification | Risk Coverage |
|----|-------|----------|---------------|---------------|---------------|
| 2.1-E2E-005 | E2E | P2 | No regression in existing document management workflow | Comprehensive regression test | **TECH-001** |

## Risk Coverage Mapping

### SEC-001: Role Assignment Security (Critical)
**Covered by**: 2.1-UNIT-005, 2.1-UNIT-006, 2.1-UNIT-007, 2.1-UNIT-008, 2.1-UNIT-009, 2.1-INT-004, 2.1-INT-006, 2.1-INT-007, 2.1-INT-008, 2.1-E2E-001, 2.1-E2E-002, 2.1-E2E-003

**Testing Focus**:
- Role assignment validation at all levels
- Cross-role access prevention
- RLS policy enforcement
- Document visibility segregation

### DATA-001: Document Visibility Consistency (High)
**Covered by**: 2.1-UNIT-002, 2.1-UNIT-004, 2.1-INT-002, 2.1-INT-003, 2.1-INT-005, 2.1-INT-009, 2.1-INT-010, 2.1-E2E-004

**Testing Focus**:
- Data persistence accuracy
- Real-time visibility updates
- State consistency across operations
- Bulk operation integrity

### TECH-001: RLS Policy Integration (High)
**Covered by**: 2.1-INT-001, 2.1-INT-011, 2.1-E2E-005

**Testing Focus**:
- Existing functionality preservation
- Policy interaction complexity
- Performance implications

### UI-001: User Interface Integration (Medium)
**Covered by**: 2.1-UNIT-001, 2.1-UNIT-003

**Testing Focus**:
- Component rendering accuracy
- User experience consistency
- Form interaction patterns

## Detailed Test Specifications

### Priority 0 Tests (MUST EXECUTE - 14 tests)

#### 2.1-UNIT-001: Role Selection Dropdown Rendering
```typescript
describe('PolicyDocumentUpload Role Selection', () => {
  it('should render role selection dropdown with administrator and executive options', () => {
    render(<PolicyDocumentUpload open={true} onOpenChange={() => {}} />);
    
    const roleSelect = screen.getByLabelText(/target role/i);
    fireEvent.click(roleSelect);
    
    expect(screen.getByText('Administrator')).toBeInTheDocument();
    expect(screen.getByText('Executive')).toBeInTheDocument();
  });
});
```

#### 2.1-UNIT-002: Form Validation Requires Role Selection
```typescript
it('should prevent upload when no role is selected', () => {
  render(<PolicyDocumentUpload open={true} onOpenChange={() => {}} />);
  
  const uploadButton = screen.getByTestId('upload-submit');
  expect(uploadButton).toBeDisabled();
  
  // Add file and title but no role
  // Button should remain disabled
});
```

#### 2.1-UNIT-004: Upload Payload Includes Role Assignment
```typescript
describe('usePolicyDocumentUpload', () => {
  it('should include role_assignment in upload payload', async () => {
    const mockFile = new File(['content'], 'test.pdf', { type: 'application/pdf' });
    
    const { uploadPolicyDocument } = usePolicyDocumentUpload();
    
    const uploadSpy = vi.spyOn(supabase.from('policy_documents'), 'insert');
    
    await uploadPolicyDocument({
      file: mockFile,
      title: 'Test Document',
      targetRole: 'executive'
    });
    
    expect(uploadSpy).toHaveBeenCalledWith(
      expect.objectContaining({
        role_assignment: 'executive'
      })
    );
  });
});
```

#### 2.1-UNIT-005: Valid Role Assignment Values
```typescript
it('should accept valid role_assignment enum values', () => {
  const validRoles = ['administrator', 'executive'];
  
  validRoles.forEach(role => {
    expect(['administrator', 'executive']).toContain(role);
  });
});
```

#### 2.1-UNIT-006: Reject Invalid Role Assignment Values
```typescript
it('should reject invalid role_assignment values', async () => {
  const mockFile = new File(['content'], 'test.pdf', { type: 'application/pdf' });
  
  const { uploadPolicyDocument } = usePolicyDocumentUpload();
  
  // Should throw or return error for invalid role
  const result = await uploadPolicyDocument({
    file: mockFile,
    title: 'Test Document',
    targetRole: 'invalid_role' as any
  });
  
  expect(result.success).toBe(false);
  expect(result.error).toContain('Invalid role');
});
```

#### 2.1-INT-001: Upload Component Hook Integration
```typescript
describe('PolicyDocumentUpload Integration', () => {
  it('should integrate role selection with upload hook', async () => {
    const mockUpload = vi.fn().mockResolvedValue({ success: true });
    vi.mocked(usePolicyDocumentUpload).mockReturnValue({
      uploadPolicyDocument: mockUpload,
      validateFile: vi.fn(),
      isUploading: false
    });
    
    render(<PolicyDocumentUpload open={true} onOpenChange={() => {}} />);
    
    // Select file, enter title, select role
    // Click upload
    
    expect(mockUpload).toHaveBeenCalledWith(
      expect.objectContaining({
        targetRole: 'executive'
      })
    );
  });
});
```

#### 2.1-INT-003: Database Role Assignment Persistence
```typescript
describe('Database Integration', () => {
  it('should persist role_assignment to database', async () => {
    const testDocument = {
      title: 'Test Executive Policy',
      role_assignment: 'executive',
      user_id: 'test-user-id'
    };
    
    const { data, error } = await supabase
      .from('policy_documents')
      .insert(testDocument)
      .select()
      .single();
    
    expect(error).toBeNull();
    expect(data.role_assignment).toBe('executive');
  });
});
```

#### 2.1-INT-004: Database Constraint Enforcement
```typescript
it('should enforce role_assignment enum constraints', async () => {
  const invalidDocument = {
    title: 'Test Document',
    role_assignment: 'invalid_role',
    user_id: 'test-user-id'
  };
  
  const { error } = await supabase
    .from('policy_documents')
    .insert(invalidDocument);
  
  expect(error).not.toBeNull();
  expect(error.message).toContain('violates check constraint');
});
```

#### 2.1-INT-006: RLS Policy Document Access Prevention
```typescript
describe('RLS Security', () => {
  it('should prevent Administrator access to Executive documents', async () => {
    // Create test users and documents
    const adminUser = await createTestUser('administrator');
    const executiveDoc = await createTestDocument('executive', 'other-user-id');
    
    // Login as administrator
    await supabase.auth.signInWithPassword({
      email: adminUser.email,
      password: 'test-password'
    });
    
    // Attempt to access executive document
    const { data, error } = await supabase
      .from('policy_documents')
      .select('*')
      .eq('id', executiveDoc.id);
    
    // Should return empty array or access denied
    expect(data).toEqual([]);
  });
});
```

#### 2.1-INT-007: Dashboard Query Role Filtering
```typescript
it('should filter dashboard queries by role assignment', async () => {
  const adminUser = await createTestUser('administrator');
  await createTestDocument('administrator', adminUser.id);
  await createTestDocument('executive', 'other-user-id');
  
  await supabase.auth.signInWithPassword({
    email: adminUser.email,
    password: 'test-password'
  });
  
  const { data } = await supabase
    .from('policy_documents')
    .select('*')
    .eq('user_id', adminUser.id);
  
  // Should only see administrator documents
  expect(data.every(doc => doc.role_assignment === 'administrator')).toBe(true);
});
```

#### 2.1-INT-008: Chat Interface Role-Based Access
```typescript
it('should respect role-based document access in chat interface', async () => {
  // Mock chat service query
  const adminUser = await createTestUser('administrator');
  const executiveDoc = await createTestDocument('executive', 'other-user-id');
  
  await supabase.auth.signInWithPassword({
    email: adminUser.email,
    password: 'test-password'
  });
  
  // Query documents for chat context
  const { data: chatDocs } = await supabase
    .from('policy_documents')
    .select('*')
    .or('user_id.eq.' + adminUser.id + ',role_assignment.eq.administrator');
  
  // Should not include executive documents
  expect(chatDocs.find(doc => doc.id === executiveDoc.id)).toBeUndefined();
});
```

#### 2.1-E2E-001: Administrator Upload with Executive Role
```typescript
describe('E2E Role Assignment', () => {
  it('should allow administrator to upload document for executive role', async () => {
    await page.goto('/dashboard');
    await loginAsAdministrator(page);
    
    // Open upload dialog
    await page.click('[data-testid="upload-button"]');
    
    // Upload file
    await page.setInputFiles('input[type="file"]', 'test-files/executive-policy.pdf');
    
    // Enter title
    await page.fill('[data-testid="document-title"]', 'Executive Test Policy');
    
    // Select executive role
    await page.selectOption('[data-testid="target-role"]', 'executive');
    
    // Submit upload
    await page.click('[data-testid="upload-submit"]');
    
    // Verify success
    await expect(page.locator('.toast-success')).toBeVisible();
  });
});
```

#### 2.1-E2E-002: Administrator Cannot See Executive Documents
```typescript
it('should prevent administrator from seeing executive documents in dashboard', async () => {
  // Pre-create executive document
  await createTestDocument('executive', 'other-user-id');
  
  await page.goto('/dashboard');
  await loginAsAdministrator(page);
  
  // Check document list
  const documents = await page.locator('[data-testid="document-item"]').all();
  
  // Should not see executive documents
  for (const doc of documents) {
    const role = await doc.getAttribute('data-role');
    expect(role).not.toBe('executive');
  }
});
```

#### 2.1-E2E-003: Chat Interface Excludes Executive Documents
```typescript
it('should exclude executive documents from administrator chat interface', async () => {
  await createTestDocument('executive', 'other-user-id', 'Executive Secret Policy');
  
  await page.goto('/chat');
  await loginAsAdministrator(page);
  
  // Ask about executive document
  await page.fill('[data-testid="chat-input"]', 'Tell me about Executive Secret Policy');
  await page.click('[data-testid="send-button"]');
  
  // Should not find document in response
  const response = await page.locator('[data-testid="chat-response"]').textContent();
  expect(response).toContain('no relevant documents found');
});
```

### Priority 1 Tests (SHOULD EXECUTE - 8 tests)

#### 2.1-UNIT-003: Default Role Assignment
```typescript
it('should default role assignment to administrator', () => {
  render(<PolicyDocumentUpload open={true} onOpenChange={() => {}} />);
  
  // Component should initialize with administrator as default
  const roleSelect = screen.getByDisplayValue('administrator');
  expect(roleSelect).toBeInTheDocument();
});
```

#### Additional P1 tests continue with detailed specifications...

### Priority 2 Tests (NICE TO HAVE - 2 tests)

#### 2.1-UNIT-009: Search Result Role Filtering
```typescript
it('should apply role-based constraints to search results', () => {
  const documents = [
    { id: '1', role_assignment: 'administrator', title: 'Admin Doc' },
    { id: '2', role_assignment: 'executive', title: 'Executive Doc' }
  ];
  
  const filteredForAdmin = filterDocumentsByRole(documents, 'administrator');
  expect(filteredForAdmin).toHaveLength(1);
  expect(filteredForAdmin[0].role_assignment).toBe('administrator');
});
```

## Test Execution Strategy

### Execution Order
1. **P0 Unit Tests** (1-6) - Fast feedback on core logic
2. **P0 Integration Tests** (1, 3, 4, 6, 7, 8) - Database and RLS validation
3. **P0 E2E Tests** (1, 2, 3) - Critical user journeys
4. **P1 Tests** - Core functionality validation
5. **P2 Tests** - If time permits

### Test Environment Requirements

#### Unit Tests
- Jest/Vitest test runner
- React Testing Library
- Mock Supabase client
- Mock file objects

#### Integration Tests
- Test Supabase instance
- Isolated test database
- Test user accounts with different roles
- RLS policy validation

#### E2E Tests
- Full application deployment
- Playwright test runner
- Test file uploads
- Multi-user session management

### Success Criteria

#### Must Pass (P0)
- All role assignment security tests
- Database constraint enforcement
- RLS policy validation
- Critical user journey completion

#### Should Pass (P1)
- UI integration consistency
- Real-time data updates
- Bulk operations
- Regression prevention

#### Nice to Have (P2)
- Search functionality
- Advanced UI scenarios

## Test Data Requirements

### Test Users
```yaml
administrator_user:
  email: 'admin-test@example.com'
  role: 'administrator'
  
executive_user:
  email: 'exec-test@example.com'
  role: 'executive'
  
super_admin_user:
  email: 'super-test@example.com'
  role: 'super_admin'
```

### Test Documents
```yaml
administrator_document:
  title: 'Admin Test Policy'
  role_assignment: 'administrator'
  
executive_document:
  title: 'Executive Test Policy'
  role_assignment: 'executive'
```

### Test Files
- `test-admin-policy.pdf` (Valid PDF, <25MB)
- `test-executive-policy.pdf` (Valid PDF, <25MB)
- `invalid-large-file.pdf` (>25MB for validation testing)
- `invalid-file.txt` (Invalid format for negative testing)

## Recommended Test Framework Configuration

### Unit Tests (Jest/Vitest)
```javascript
// vitest.config.ts
export default defineConfig({
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    coverage: {
      reporter: ['text', 'json', 'html'],
      thresholds: {
        global: {
          branches: 80,
          functions: 80,
          lines: 80,
          statements: 80
        }
      }
    }
  }
});
```

### Integration Tests (Supabase)
```typescript
// integration-test-config.ts
export const testConfig = {
  supabase: {
    url: process.env.TEST_SUPABASE_URL,
    anonKey: process.env.TEST_SUPABASE_ANON_KEY,
    serviceKey: process.env.TEST_SUPABASE_SERVICE_KEY
  },
  testUsers: {
    admin: 'admin-test@example.com',
    executive: 'exec-test@example.com'
  }
};
```

### E2E Tests (Playwright)
```typescript
// playwright.config.ts
export default defineConfig({
  testDir: './tests/e2e',
  use: {
    baseURL: process.env.TEST_BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure'
  },
  projects: [
    {
      name: 'role-assignment',
      testMatch: '**/2.1-*.spec.ts'
    }
  ]
});
```