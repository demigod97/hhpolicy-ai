# Story 2.3: Advanced RAG - Date Metadata Extraction - Brownfield Addition

## Status
Ready

## Story
**As a** System,
**I want** to enhance the ingestion workflow to identify and extract date metadata from policy documents,
**So that** the document's age can be tracked for compliance purposes.

## Story Context

**Existing System Integration:**
- Integrates with: Story 1.4 RAG ingestion workflow, existing N8N document processing
- Technology: N8N workflow automation, LLM integration for date parsing, policy_documents database schema
- Follows pattern: Existing N8N document processing and metadata extraction patterns
- Touch points: Document ingestion → Date extraction via LLM → Database metadata storage → Age flagging preparation

## Acceptance Criteria

**Functional Requirements:**
1. The N8N ingestion workflow is updated to include a step that uses an LLM to find and parse date-related information (e.g., "Effective Date", "Last Updated")
2. The extracted date, if found, is saved in a dedicated field in the `policy_documents` table
3. If no date can be reliably determined, the date field for that document remains null
4. The process handles common date formats and variations in policy documents

**Integration Requirements:**
5. Existing RAG ingestion workflow (Story 1.4) continues to work unchanged
6. New date extraction step integrates seamlessly into existing N8N pipeline
7. Integration with policy_documents table maintains current schema and relationships

**Quality Requirements:**
8. Date extraction accuracy is validated through comprehensive testing
9. Processing time increase is minimal (under 30 seconds additional)
10. Handles edge cases gracefully (malformed dates, multiple dates, ambiguous formats)

## Technical Notes

- **Integration Approach:** Extend existing N8N RAG workflow with LLM-powered date extraction step
- **Existing Pattern Reference:** Leverage existing LLM integration patterns for metadata extraction
- **Key Constraints:** Must handle document variations and date format inconsistencies reliably

## Definition of Done

- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Date extraction could slow down document processing or produce inaccurate results
- **Mitigation:** Implement timeout limits, fallback mechanisms, and confidence scoring
- **Rollback:** Disable date extraction step, leave date fields null

**Compatibility Verification:**
- [ ] No breaking changes to existing APIs
- [ ] Database changes are additive only (new date field)
- [ ] N8N workflow changes maintain existing functionality
- [ ] Performance impact is acceptable

## Tasks / Subtasks

- [ ] **Task 1: Database Schema Enhancement**
  - [ ] Add date metadata fields to policy_documents table
  - [ ] Design schema for effective_date, last_updated_date, date_confidence
  - [ ] Create database migration for new date fields
  - [ ] Ensure backward compatibility with existing records

- [ ] **Task 2: N8N Date Extraction Workflow**
  - [ ] Integrate LLM date extraction step into existing RAG workflow
  - [ ] Design prompts for identifying common policy date patterns
  - [ ] Implement date parsing and validation logic
  - [ ] Add error handling and fallback mechanisms

- [ ] **Task 3: Date Processing Intelligence**
  - [ ] Handle multiple date formats (MM/DD/YYYY, DD/MM/YYYY, Month DD, YYYY, etc.)
  - [ ] Identify policy-specific date terminology ("Effective Date", "Revision Date", etc.)
  - [ ] Implement confidence scoring for extracted dates
  - [ ] Add logic for choosing between multiple detected dates

- [ ] **Task 4: Testing & Validation**
  - [ ] Create test dataset with various policy document date formats
  - [ ] Validate date extraction accuracy across different document types
  - [ ] Test performance impact on overall processing time
  - [ ] Verify graceful handling of documents without dates

## Dev Notes

### Date Extraction Strategy
- **LLM Prompt Design**: Target common policy date patterns and terminology
- **Date Priority**: Effective Date > Last Updated > Revision Date > Creation Date
- **Confidence Scoring**: Rate extraction confidence based on context and format clarity
- **Fallback Logic**: If multiple dates found, choose most recent or most reliable

### Database Schema Changes
```sql
ALTER TABLE policy_documents ADD COLUMN effective_date DATE;
ALTER TABLE policy_documents ADD COLUMN last_updated_date DATE;
ALTER TABLE policy_documents ADD COLUMN date_extracted_at TIMESTAMP;
ALTER TABLE policy_documents ADD COLUMN date_confidence FLOAT;
```

### N8N Workflow Integration
1. **Text Analysis**: Pass document text to LLM for date identification
2. **Date Parsing**: Convert identified date strings to standardized format
3. **Validation**: Check date reasonableness and confidence
4. **Storage**: Update policy_documents record with extracted metadata
5. **Fallback**: Continue processing even if date extraction fails

### LLM Prompt Template
```
Analyze this policy document text and extract date information:
- Look for: Effective Date, Last Updated, Revision Date, Policy Date
- Return: Date value and confidence score (0-1)
- Format: YYYY-MM-DD or null if no reliable date found
- Context: Include surrounding text for verification
```

### Key Files to Create/Modify
- Database migration for date fields
- N8N workflow updates for date extraction
- Date parsing and validation utilities
- LLM prompt templates and processing logic

### Testing Requirements
- **Unit Tests**: Date parsing logic, format handling
- **Integration Tests**: Complete N8N workflow with date extraction
- **Accuracy Tests**: Date extraction accuracy across document samples
- **Performance Tests**: Processing time impact measurement

### Edge Cases to Handle
- Multiple dates in same document
- Ambiguous date formats (MM/DD vs DD/MM)
- Future dates (likely errors)
- Very old dates (pre-digital era)
- Non-English date formats
- Corrupted or OCR-mangled dates

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-01-19 | 1.0 | Initial story creation for date metadata extraction | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here*