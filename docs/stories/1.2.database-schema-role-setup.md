# Story 1.2: Initial Database Schema & Role Setup

## Status
Draft

## Story
**As a** Super-Admin,
**I want** the initial database schema with support for user roles,
**so that** I can create and manage the first Administrator accounts.

## Acceptance Criteria
1. A database migration script updates the schema to include tables for `user_roles` and `policy_documents` (renamed from `notebooks`).
2. A mechanism exists (e.g., a script or manual Supabase command) to assign a new user the 'Administrator' role.
3. The RLS policy for `policy_documents` is updated to ensure users can only see documents they own for now.

## Tasks / Subtasks
- [ ] Task 1: Create Database Migration (AC: 1)
  - [ ] Create migration script to rename `notebooks` table to `policy_documents`
  - [ ] Add `user_roles` table with appropriate schema
  - [ ] Add role assignment fields to existing user table
  - [ ] Update foreign key references and constraints
- [ ] Task 2: Implement Role Assignment Mechanism (AC: 2)
  - [ ] Create Supabase function or script to assign Administrator role
  - [ ] Add role validation logic
  - [ ] Create admin interface or command for role management
  - [ ] Test role assignment functionality
- [ ] Task 3: Update RLS Policies (AC: 3)
  - [ ] Update RLS policy for `policy_documents` table
  - [ ] Ensure users can only access their own documents
  - [ ] Add role-based access controls
  - [ ] Test RLS policies with different user roles

## Dev Notes

### Database Schema Design
Based on the PRD requirements, the system needs to support:
- **User Roles**: Administrator and Executive (with Super-Admin for management)
- **Policy Documents**: Renamed from notebooks, with role-based access
- **Row Level Security**: Enforce access controls at the database level

### Required Tables
```sql
-- User roles table
CREATE TABLE user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  role TEXT NOT NULL CHECK (role IN ('administrator', 'executive', 'super_admin')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Policy documents table (renamed from notebooks)
CREATE TABLE policy_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  title TEXT NOT NULL,
  role_assignment TEXT CHECK (role_assignment IN ('administrator', 'executive')),
  processing_status TEXT DEFAULT 'processing',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### RLS Policy Requirements
- Users can only see policy documents they own
- Super-admins can see all documents
- Role-based filtering will be implemented in later stories

### Key Files to Create/Modify
- `supabase/migrations/` - New migration file for schema changes
- `supabase/functions/` - Role assignment functions
- `src/integrations/supabase/types.ts` - Update TypeScript types
- `src/services/authService.ts` - Add role management functions

### Testing
- **Unit Tests**: Test role assignment functions
- **Integration Tests**: Verify RLS policies work correctly
- **Database Tests**: Ensure migration runs successfully

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-01-17 | 1.0 | Initial story creation from PRD | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here*
